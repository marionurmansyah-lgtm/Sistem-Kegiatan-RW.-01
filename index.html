<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sinergi RW.01 - Kebon Manggis</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Sinergi 01">
    <link rel="apple-touch-icon" href="https://scvydobptkuvfthligiw.supabase.co/storage/v1/object/public/Logo/1746898459176.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        canvas { border: 2px dashed #cbd5e1; background: #f8fafc; border-radius: 1rem; width: 100%; height: 150px; }
        .branding-line { height: 5px; width: 100%; background: linear-gradient(to right, #e11d48 25%, #f8fafc 25%, #f8fafc 50%, #fbbf24 50%, #fbbf24 75%, #059669 75%); position: fixed; top: 0; left: 0; z-index: 1000; }
        footer { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #e2e8f0; z-index: 50; }
        
        .running-text-container { background: #FFFF00; border-bottom: 1px solid #e2e8f0; overflow: hidden; white-space: nowrap; display: flex; align-items: center; height: 30px; }
        .running-text-content { display: inline-block; padding-left: 100%; animation: marquee 20s linear infinite; font-size: 10px; font-weight: 700; color: #0f172a; text-transform: uppercase; }
        @keyframes marquee { 0% { transform: translate(0, 0); } 100% { transform: translate(-100%, 0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 no-scrollbar pb-24">
    <div class="branding-line"></div>
    <div id="toast" class="fixed top-8 right-4 z-[999] px-6 py-3 rounded-xl shadow-2xl text-white font-bold hidden transition-all"></div>

    <div id="page-login" class="page flex items-center justify-center min-h-screen p-4 animate-fade">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md text-center border border-slate-100">
            <img class="w-20 h-20 mx-auto mb-4" src="https://scvydobptkuvfthligiw.supabase.co/storage/v1/object/public/Logo/1746898459176.png">
            <h1 class="text-xl font-black text-emerald-700 uppercase leading-none">Sinergi RW.01</h1>
            <p class="text-[9px] font-bold text-slate-400 mt-2 tracking-[0.3em]">KEBON MANGGIS</p>
            <form id="form-login" class="mt-8 space-y-4 text-left">
                <input type="text" id="login-user" placeholder="Username" class="w-full border-2 border-slate-50 bg-slate-50 p-4 rounded-2xl outline-none focus:border-emerald-500" required>
                <div class="relative">
                    <input type="password" id="login-pass" placeholder="Password" class="w-full border-2 border-slate-50 bg-slate-50 p-4 rounded-2xl outline-none focus:border-emerald-500" required>
                    <button type="button" onclick="togglePass('login-pass')" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400"><i data-lucide="eye" class="w-5 h-5"></i></button>
                </div>   
                <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-all">Masuk</button>
            </form>
            <p class="mt-6 text-sm">Warga baru? <button onclick="showPage('page-register')" class="text-emerald-600 font-bold">Daftar</button></p>
        </div>
    </div>

    <div id="page-register" class="page hidden flex items-center justify-center min-h-screen p-4 animate-fade">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md border border-slate-100">
            <h2 class="text-lg font-black text-center uppercase mb-6">Pendaftaran Warga</h2>
            <form id="form-register" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="reg-nama" placeholder="Nama Lengkap" class="w-full border-2 border-slate-100 bg-slate-50 p-3 rounded-xl text-xs outline-none" required>
                    <select id="reg-rt" class="w-full border-2 border-slate-100 bg-slate-50 p-3 rounded-xl text-xs font-bold" required>
                        <option value="">Pilih RT</option>
                        <script>for(let i=1;i<=16;i++) document.write(`<option value="RT ${i.toString().padStart(2,'0')}">RT ${i.toString().padStart(2,'0')}</option>`)</script>
                    </select>
                </div>
                <input type="tel" id="reg-hp" placeholder="Nomor WhatsApp" class="w-full border-2 border-slate-100 bg-slate-50 p-3 rounded-xl text-xs outline-none" required>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="reg-user" placeholder="Username" class="w-full border-2 border-slate-100 bg-slate-50 p-3 rounded-xl text-xs outline-none" required>                        
                    <input type="password" id="reg-pass" placeholder="Password" class="w-full border-2 border-slate-100 bg-slate-50 p-3 rounded-xl text-xs outline-none" required>
                </div>
                <select id="reg-kategori" onchange="updateSubJabatan()" class="w-full p-3 border-2 border-slate-100 bg-slate-50 rounded-xl text-xs font-bold">
                    <option value="Warga">Warga</option>
                    <option value="Pengurus RW">Pengurus RW</option>
                    <option value="Pengurus RT">Pengurus RT</option>
                    <option value="Kader">Kader</option>
                    <option value="Seksi Pendidikan">Seksi Pendidikan</option>
                    <option value="Keamanan">Keamanan</option>
                    <option value="Kebersihan">Kebersihan</option>                                              
                    <option value="Karang Taruna">Karang Taruna</option>
                </select>
                <div id="reg-sub-jabatan-container" class="hidden">
                    <select id="reg-sub-jabatan" class="w-full p-3 border-2 border-slate-100 bg-slate-50 rounded-xl text-xs"></select>
                </div>
                <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black uppercase text-xs mt-4">Daftar Sekarang</button>
                <button type="button" onclick="showPage('page-login')" class="w-full text-slate-400 text-[10px] font-bold uppercase py-2 text-center">Batal & Kembali</button>
            </form>
        </div>
    </div>
    
    <div id="page-user" class="page hidden animate-fade">
       <header class="bg-white/90 backdrop-blur-md px-6 py-4 border-b sticky top-0 z-[60] flex justify-between items-center">
    <div class="flex items-center gap-3">
        <img class="w-14 h-14 object-contain" src="https://scvydobptkuvfthligiw.supabase.co/storage/v1/object/public/Logo/1746898459176.png">
        <div>
            <h1 class="font-black text-emerald-800 text-[14px] uppercase leading-none">SINERGI01</h1>
            <p class="text-slate-500 text-[8px] font-bold uppercase mt-1 leading-tight">
                Portal Sistem Kegiatan RW01<br>
                Kel.Kebon Manggis Kec.Matraman
            </p>
        </div>
    </div>
    <button onclick="logout()" class="flex items-center gap-1 bg-rose-50 px-3 py-2 rounded-lg active:scale-95 transition-all">
        <span class="text-[9px] font-black text-rose-600 uppercase">Keluar</span>
        <i data-lucide="log-out" class="w-3 h-3 text-rose-600"></i>
    </button>
</header>

        <div class="running-text-container">
            <div class="running-text-content">Selamat Datang di Portal Sinergi RW.01 Kebon Manggis • Jalin Silaturahmi, Bangun Lingkungan • salam sinergi!</div>
        </div>

        <main class="p-4 space-y-6">
            <div class="bg-gradient-to-br from-emerald-600 to-teal-700 p-6 rounded-[2rem] text-white shadow-lg relative overflow-hidden">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div class="space-y-1">
                        <p class="text-[8px] font-black opacity-80 uppercase tracking-[0.2em]">Profil Warga</p>
                        <h2 id="kartu-nama" class="text-lg font-black uppercase leading-tight">...</h2>
                        <p id="kartu-jabatan" class="text-[9px] font-medium opacity-90 italic">...</p>
                    </div>
                    <div class="text-right border-l border-white/20 pl-4">
                        <div id="user-realtime-clock" class="text-sm font-black tracking-tighter"></div>
                        <div id="user-realtime-date" class="text-[7px] font-bold opacity-80 uppercase"></div>
                    </div>
                </div>
            </div>

            <div id="user-content-area" class="pb-24 space-y-4"></div>
            
            <div class="text-center opacity-40 pb-20">
                <p class="text-[10px] font-bold uppercase tracking-widest">©2026 Sekretariat Team-rionurmansyah_nachruli</p>
            </div>
        </main>

        <footer>
            <div class="flex justify-around items-center p-3">
                <button onclick="switchTabWarga('pengumuman')" class="nav-btn flex flex-col items-center text-emerald-600"><i data-lucide="home" class="w-5 h-5"></i><span class="text-[8px] font-bold uppercase mt-1">Beranda</span></button>
                <button onclick="switchTabWarga('agenda')" class="nav-btn flex flex-col items-center text-slate-400"><i data-lucide="calendar-days" class="w-5 h-5"></i><span class="text-[8px] font-bold uppercase mt-1">Agenda</span></button>
                <button onclick="switchTabWarga('dokumentasi')" class="nav-btn flex flex-col items-center text-slate-400"><i data-lucide="image" class="w-5 h-5"></i><span class="text-[8px] font-bold uppercase mt-1">Galeri</span></button>
                <button onclick="switchTabWarga('riwayat')" class="nav-btn flex flex-col items-center text-slate-400"><i data-lucide="history" class="w-5 h-5"></i><span class="text-[8px] font-bold uppercase mt-1">Riwayat</span></button>
            </div>
        </footer>
    </div>

    <div id="modal-absen" class="fixed inset-0 bg-black/80 z-[200] hidden p-4 flex items-center justify-center">
        <div class="bg-white w-full max-w-md p-6 rounded-[2rem] space-y-4">
            <h3 class="font-black text-center uppercase text-sm">Form Kehadiran</h3>
            <form id="form-submit-absen" class="space-y-4">
                <input type="hidden" id="abs-kegiatan-id">
                <input type="file" id="abs-selfie" accept="image/*" capture="user" class="hidden" required>
                <button type="button" onclick="document.getElementById('abs-selfie').click()" class="w-full border-2 border-dashed p-4 rounded-xl text-[10px] font-bold text-slate-400 uppercase">Ambil Foto Selfie</button>
                <canvas id="canvas-ttd"></canvas>
                <button type="button" onclick="signaturePad.clear()" class="text-[8px] font-bold text-rose-500 uppercase">Hapus TTD</button>
                <button type="submit" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-black uppercase shadow-lg">Kirim</button>
                <button type="button" onclick="document.getElementById('modal-absen').classList.add('hidden')" class="w-full text-slate-400 text-[10px] font-bold uppercase">Batal</button>
            </form>
        </div>
    </div>

    <script>
        const SHEETDB_URL = "https://sheetdb.io/api/v1/zrnc1n8cotdok";
        const SB_URL = "https://scvydobptkuvfthligiw.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdnlkb2JwdGt1dmZ0aGxpZ2l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDE0MTcsImV4cCI6MjA4NTg3NzQxN30.B-SrN_fKGapu31wGw5etAR_fT4gm4fcD69eGBXRokkA";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);
        let signaturePad;

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            lucide.createIcons();
        }

        function notify(msg, color = "bg-emerald-600") {
            const t = document.getElementById('toast');
            t.textContent = msg; t.className = `fixed top-8 right-4 z-[999] px-6 py-3 rounded-xl text-white font-bold animate-fade ${color}`;
            t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 3000);
        }

        async function switchTabWarga(tab) {
            const list = document.getElementById('user-content-area');
            if (!list) return;
            const user = JSON.parse(localStorage.getItem('user')) || {};
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-emerald-600');
                btn.classList.add('text-slate-400');
            });

            list.innerHTML = '<p class="text-center py-20 text-[10px] font-bold text-slate-300 tracking-widest">MEMUAT...</p>';

            try {
                if(tab === 'pengumuman') {
                    const { data } = await _supabase.from('pengumuman').select('*').order('created_at', {ascending: false});
                    list.innerHTML = (data && data.length > 0) ? data.map(i => `
                        <div class="bg-white p-5 rounded-3xl border shadow-sm mb-4 animate-fade">
                            <span class="text-[8px] font-black uppercase px-2 py-1 rounded bg-blue-50 text-blue-600">${i.tipe}</span>
                            <h4 class="font-black text-sm my-2 uppercase">${i.judul}</h4>
                            <p class="text-slate-500 text-[10px] mb-4">${i.detail}</p>
                            ${i.tipe === 'Kegiatan' ? `<button onclick="bukaAbsen('${i.id}')" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-black text-[10px] uppercase">Klik Absen</button>` : ''}
                        </div>`).join('') : '<p class="text-center py-10 text-xs">Kosong</p>';
                }
                else if(tab === 'agenda') {
                    const res = await fetch(`${SHEETDB_URL}?sheet=agenda`);
                    const data = await res.json();
                    list.innerHTML = data.map(item => `
                        <div class="flex gap-4 bg-white p-4 rounded-2xl border items-center">
                            <div class="bg-emerald-50 text-emerald-700 min-w-[45px] h-[45px] flex flex-col justify-center items-center rounded-xl font-black">
                                <span class="text-sm">${item.tanggal ? item.tanggal.split('-')[2] : '?'}</span>
                            </div>
                            <div>
                                <h4 class="text-[10px] font-black uppercase leading-tight">${item.kegiatan}</h4>
                                <p class="text-[8px] text-slate-400 mt-1 uppercase font-bold">${item.jam} • ${item.lokasi}</p>
                            </div>
                        </div>`).join('');
                }
                else if(tab === 'riwayat') {
                    const res = await fetch(`${SHEETDB_URL}?sheet=absen`);
                    const all = await res.json();
                    const mine = all.filter(a => a.nama_warga === user.nama);
                    list.innerHTML = `
                        <div class="bg-white p-5 rounded-3xl text-center border mb-4">
                            <div id="qrcode" class="flex justify-center mb-2"></div>
                            <p class="text-[8px] font-black text-emerald-600 uppercase italic">Scan Link Portal</p>
                        </div>
                        <div class="space-y-2">
                            ${mine.reverse().map(r => `
                                <div class="bg-white p-3 rounded-xl border flex justify-between items-center">
                                    <p class="font-black text-[9px] uppercase text-slate-700 leading-none">Hadir: ${r.waktu_absen}</p>
                                    <span class="text-[7px] font-black text-emerald-600 bg-emerald-50 px-2 py-1 rounded">OK</span>
                                </div>`).join('')}
                        </div>`;
                    setTimeout(() => {
                        const qr = document.getElementById("qrcode");
                        if (qr) new QRCode(qr, { text: window.location.href, width: 100, height: 100 });
                    }, 300);
                }
            } catch (err) { console.error(err); }
            lucide.createIcons();
        }

        // --- AUTH ---
        document.getElementById('form-login').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('login-user').value;
            const p = document.getElementById('login-pass').value;
            notify("Pengecekan...", "bg-blue-600");
            const res = await fetch(`${SHEETDB_URL}?sheet=users`);
            const users = await res.json();
            const found = users.find(user => user.username === u && user.password === p);
            if(found) {
                localStorage.setItem('user', JSON.stringify(found));
                location.reload();
            } else { notify("Username/Password Salah!", "bg-rose-600"); }
        };

        function bukaAbsen(id) {
            document.getElementById('abs-kegiatan-id').value = id;
            document.getElementById('modal-absen').classList.remove('hidden');
            const canvas = document.getElementById('canvas-ttd');
            canvas.width = canvas.offsetWidth;
            signaturePad = new SignaturePad(canvas);
        }

        function logout() { localStorage.clear(); location.reload(); }
        function togglePass(id) { const el = document.getElementById(id); el.type = el.type === "password" ? "text" : "password"; }

        setInterval(() => {
            const now = new Date();
            if(document.getElementById('user-realtime-date')) document.getElementById('user-realtime-date').innerText = now.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'short' }).toUpperCase();
            if(document.getElementById('user-realtime-clock')) document.getElementById('user-realtime-clock').innerText = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' }) + " WIB";
        }, 1000);

       window.onload = () => {
    const saved = localStorage.getItem('user');
    if (saved) {
        const user = JSON.parse(saved);
        
        // 1. Tampilkan Halaman Utama
        showPage('page-user');

        // 2. Isi Data ke Kartu Profil (Warna Hijau)
        const n = document.getElementById('kartu-nama');
        const j = document.getElementById('kartu-jabatan');
        if(n) n.innerText = user.nama;
        if(j) j.innerText = `${user.jabatan} | ${user.rt}`;
        
        // 3. Muat Konten Tab Pertama (Jeda sedikit agar aman)
        setTimeout(() => {
            switchTabWarga('pengumuman');
        }, 300);
    }
    lucide.createIcons();
};

    </script>
</body>
</html>
