<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Sinergi RW.01</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://scvydobptkuvfthligiw.supabase.co/storage/v1/object/public/Logo/1746898459176.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
        .sidebar-item { transition: all 0.3s ease; cursor: pointer; background: transparent; color: #64748b; position: relative; }
        .sidebar-item:hover { background: rgba(16, 185, 129, 0.1); color: #10b981; }
        .sidebar-item.active-tab { background: rgba(16, 185, 129, 0.15); color: #10b981; font-weight: 700; }
        .sidebar-item.active-tab::before { content: ''; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: #10b981; }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex">

    <aside class="w-64 bg-white border-r hidden md:flex flex-col sticky top-0 h-screen">
        <div class="p-6 border-b text-center">
            <img class="w-20 h-20 mx-auto mb-2" src="https://scvydobptkuvfthligiw.supabase.co/storage/v1/object/public/Logo/1746898459176.png">
            <h1 class="font-black text-emerald-800 text-sm">ADMIN RW.01</h1>
            <p class="text-slate-500 text-xs">Kel.Kebon Manggis Kec.Matraman</p>
        </div>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <button onclick="switchTab('pengumuman', this)" class="sidebar-item active-tab w-full flex items-center gap-3 p-3 rounded-xl font-bold text-xs uppercase">
                <i data-lucide="megaphone" class="w-4 h-4"></i> Pengumuman
            </button>
            <button onclick="switchTab('dokumentasi', this)" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl font-bold text-xs uppercase">
                <i data-lucide="camera" class="w-4 h-4"></i> Dokumentasi
            </button>
            <button onclick="switchTab('laporan', this)" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl font-bold text-xs uppercase">
                <i data-lucide="printer" class="w-4 h-4"></i> Laporan Absensi
            </button>
            <button onclick="switchTab('users', this)" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl font-bold text-xs uppercase">
                <i data-lucide="users" class="w-4 h-4"></i> Kelola User
            </button>
            <button onclick="switchTab('agenda', this)" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl font-bold text-xs uppercase">
                <i data-lucide="calendar" class="w-4 h-4"></i> Kelola Agenda
            </button>
            <button onclick="switchTab('setting', this)" class="sidebar-item w-full flex items-center gap-3 p-3 rounded-xl font-bold text-xs uppercase">
                <i data-lucide="settings" class="w-4 h-4"></i> Pengaturan
            </button>
        </nav>
        <div class="p-4 border-t">
            <button onclick="logoutAdmin()" class="w-full bg-rose-50 text-rose-600 p-3 rounded-xl font-bold text-[10px] uppercase">Keluar Admin</button>
        </div>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="content-header" class="mb-8">
            <h2 id="tab-title" class="text-2xl font-black text-slate-800 uppercase">Kelola Pengumuman</h2>
            <p class="text-slate-500 text-xs">RW.01 Kebon Manggis Digital Informasi System</p>
        </div>

        <div id="sec-pengumuman" class="tab-content space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border">
                <h3 class="font-black text-sm uppercase mb-4">Buat Pengumuman Baru</h3>
                <div class="grid gap-4">
                    <input type="text" id="p-judul" placeholder="Judul Pengumuman" class="border p-3 rounded-xl text-sm outline-none">
                    <select id="p-tipe" class="border p-3 rounded-xl text-sm bg-white">
                        <option value="Informasi">Informasi Biasa</option>
                        <option value="Kegiatan">Kegiatan (Aktifkan Absensi)</option>
                    </select>
                    <textarea id="p-detail" placeholder="Isi detail..." class="border p-3 rounded-xl text-sm h-32 outline-none"></textarea>

<div class="space-y-1">
    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Lampiran Foto/Gambar (PWA)</label>
    <input type="file" id="p-file-foto" accept="image/*" class="w-full text-[10px] border p-2 rounded-xl bg-slate-50">
</div>
<input type="file" id="p-file-pdf" accept="application/pdf" class="w-full text-[10px] border p-2 rounded-xl">
<button onclick="postPengumuman()" class="bg-emerald-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">Posting</button>

                </div>
            </div>
            <div class="bg-white rounded-3xl border shadow-sm overflow-x-auto">
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-slate-50 border-b">
                        <tr><th class="p-4">Tanggal</th><th class="p-4">Judul</th><th class="p-4">File</th><th class="p-4">Aksi</th></tr>
                    </thead>
                    <tbody id="log-pengumuman-body"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-dokumentasi" class="tab-content hidden space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border">
                <h3 class="font-black text-sm uppercase mb-4 text-emerald-700">Upload Dokumentasi</h3>
                <div class="space-y-4">
                    <input type="text" id="d-judul" placeholder="Nama Kegiatan" class="w-full border p-3 rounded-xl text-sm">
                    <input type="file" id="d-foto" class="w-full text-xs" accept="image/*">
                    <button onclick="postDokumentasi()" class="bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-lg">Upload</button>
                </div>
            </div>
        </div>

        <div id="sec-laporan" class="tab-content hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl border shadow-sm flex justify-between items-center">
                <h4 class="font-black uppercase text-xs">Master Absensi</h4>
                <button onclick="downloadPDFMaster()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold text-xs flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> DOWNLOAD PDF
                </button>
            </div>
            <div class="bg-white rounded-3xl border shadow-sm overflow-x-auto">
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-slate-50 uppercase">
                        <tr><th class="p-4">Warga</th><th class="p-4">RT</th><th class="p-4">Waktu</th><th class="p-4">Bukti</th></tr>
                    </thead>
                    <tbody id="table-absen-body"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-users" class="tab-content hidden space-y-4">
            <div class="bg-white p-6 rounded-3xl border shadow-sm flex justify-between items-center">
                <h4 class="font-black uppercase text-xs">Daftar Warga</h4>
                <input type="text" onkeyup="filterUser(this.value)" placeholder="Cari..." class="border p-2 rounded-xl text-[10px] w-40">
            </div>
            <div class="bg-white rounded-3xl border shadow-sm overflow-x-auto">
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-slate-50 font-black">
                        <tr><th class="p-4">Nama</th><th class="p-4">User</th><th class="p-4">RT/Jabatan</th><th class="p-4">Aksi</th></tr>
                    </thead>
                    <tbody id="table-user-body"></tbody>
                </table>
            </div>
        </div>

        <div id="sec-agenda" class="tab-content hidden space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border">
                <h3 class="font-black text-sm uppercase mb-4 text-emerald-700">Tambah Agenda</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="date" id="ag-tanggal" class="border p-3 rounded-xl text-sm">
                    <input type="text" id="ag-kegiatan" placeholder="Kegiatan" class="border p-3 rounded-xl text-sm">
                    <input type="text" id="ag-jam" placeholder="Jam" class="border p-3 rounded-xl text-sm">
                    <input type="text" id="ag-lokasi" placeholder="Lokasi" class="border p-3 rounded-xl text-sm">
                    <button onclick="postAgenda()" class="md:col-span-2 bg-emerald-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">Simpan</button>
                </div>
            </div>
            <div id="list-agenda-admin" class="bg-white rounded-3xl border divide-y overflow-hidden"></div>
        </div>

        <div id="sec-setting" class="tab-content hidden space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm border">
                <h3 class="font-black text-sm uppercase mb-4 text-amber-600">Update Running Text</h3>
                <textarea id="set-running-text" placeholder="Teks Berjalan..." class="w-full border p-4 rounded-xl text-xs h-24 outline-none"></textarea>
                <button onclick="updateRunningText()" class="bg-amber-500 text-white px-8 py-3 rounded-xl font-bold text-xs uppercase shadow-lg mt-4">Update</button>
            </div>
        </div>
    </main>

    <div id="modal-edit" class="fixed inset-0 bg-black/50 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-8">
            <h3 class="font-black text-emerald-800 uppercase mb-6">Edit Warga</h3>
            <div class="space-y-4">
                <input type="hidden" id="edit-old-user">
                <input type="text" id="edit-nama" placeholder="Nama" class="w-full border p-3 rounded-xl text-xs">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="edit-rt" placeholder="RT" class="w-full border p-3 rounded-xl text-xs">
                    <input type="text" id="edit-jabatan" placeholder="Jabatan" class="w-full border p-3 rounded-xl text-xs">
                </div>
                <input type="text" id="edit-hp" placeholder="WhatsApp" class="w-full border p-3 rounded-xl text-xs">
                <div class="flex gap-2 pt-4">
                    <button onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold text-xs uppercase">Batal</button>
                    <button onclick="updateUser()" class="flex-1 bg-emerald-600 text-white py-3 rounded-xl font-bold text-xs uppercase shadow-lg">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="image-viewer" class="fixed inset-0 bg-black/90 z-[200] hidden flex-col items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <img id="full-image" class="max-w-full max-h-[80vh] rounded-2xl">
        <p id="image-caption" class="text-white mt-4 font-black uppercase text-sm"></p>
    </div>

    <script>
        const SHEETDB_URL = "https://sheetdb.io/api/v1/zrnc1n8cotdok";
        const SB_URL = "https://scvydobptkuvfthligiw.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjdnlkb2JwdGt1dmZ0aGxpZ2l3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMDE0MTcsImV4cCI6MjA4NTg3NzQxN30.B-SrN_fKGapu31wGw5etAR_fT4gm4fcD69eGBXRokkA";
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(`sec-${tab}`).classList.remove('hidden');
            if(btn) btn.classList.add('active-tab');
            document.getElementById('tab-title').innerText = `Kelola ${tab}`;
            
            if(tab === 'laporan') loadAbsensiData();
            if(tab === 'users') loadUsers();
            if(tab === 'pengumuman') loadLogPengumuman();
            if(tab === 'agenda') loadAgendaAdmin();
            lucide.createIcons();
        }

        async function postPengumuman() {
    const vJudul = document.getElementById('p-judul').value;
    const vTipe = document.getElementById('p-tipe').value;
    const vDetail = document.getElementById('p-detail').value;
    
    // Tangkap kedua file
    const filePdf = document.getElementById('p-file-pdf').files[0];
    const fileFoto = document.getElementById('p-file-foto').files[0]; // Input baru

    if(!vJudul || !vDetail) return alert("Lengkapi data!");

    try {
        let pdfUrl = null;
        let fotoUrl = "-"; // Default

        // PROSES 1: Upload PDF ke Supabase jika ada
        if (filePdf) {
            const fileName = `undangan_${Date.now()}.pdf`;
            await _supabase.storage.from('media-sinergi').upload(`undangan/${fileName}`, filePdf);
            const { data: pUrl } = _supabase.storage.from('media-sinergi').getPublicUrl(`undangan/${fileName}`);
            pdfUrl = pUrl.publicUrl;
        }

        // PROSES 2: Upload FOTO ke Supabase jika ada
        if (fileFoto) {
            const fileName = `img_${Date.now()}.jpg`;
            await _supabase.storage.from('media-sinergi').upload(`pengumuman/${fileName}`, fileFoto);
            const { data: fUrl } = _supabase.storage.from('media-sinergi').getPublicUrl(`pengumuman/${fileName}`);
            fotoUrl = fUrl.publicUrl;
        }

        // PROSES 3: Kirim SEMUA ke SheetDB (Pastikan kolom file_url ada di Sheet)
        const payload = {
            judul: vJudul,
            tipe: vTipe,
            detail: vDetail,
            pdf_url: pdfUrl,   // Jika kamu pakai kolom berbeda
            file_url: fotoUrl, // Ini yang tadi menyebabkan error 'column not found'
            created_at: new Date().toISOString()
        };

        // Ganti ke SheetDB agar sinkron dengan data warga
        const res = await fetch(`${SHEETDB_URL}?sheet=pengumuman`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ data: [payload] })
        });

        if (res.ok) {
            alert("Berhasil di-posting!");
            loadLogPengumuman();
            // Reset form
            document.getElementById('p-judul').value = "";
            document.getElementById('p-detail').value = "";
            document.getElementById('p-file-pdf').value = "";
            document.getElementById('p-file-foto').value = "";
        }
    } catch (err) { alert("Error: " + err.message); }
}
        async function loadLogPengumuman() {
            const { data } = await _supabase.from('pengumuman').select('*').order('created_at', { ascending: false });
            document.getElementById('log-pengumuman-body').innerHTML = data.map(p => `
                <tr class="border-b">
                    <td class="p-4">${new Date(p.created_at).toLocaleDateString('id-ID')}</td>
                    <td class="p-4"><div class="font-bold">${p.judul}</div><div class="text-[8px]">${p.tipe}</div></td>
                    <td class="p-4">${p.file_url ? `<a href="${p.file_url}" target="_blank" class="text-blue-600">PDF</a>` : '-'}</td>
                    <td class="p-4"><button onclick="hapusPengumuman('${p.id}')" class="text-rose-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function hapusPengumuman(id) {
            if(!confirm("Hapus?")) return;
            await _supabase.from('pengumuman').delete().eq('id', id);
            loadLogPengumuman();
        }

        async function loadUsers() {
            const res = await fetch(`${SHEETDB_URL}?sheet=users`);
            const data = await res.json();
            document.getElementById('table-user-body').innerHTML = data.map(u => `
                <tr class="border-t">
                    <td class="p-4 font-bold">${u.nama}</td>
                    <td class="p-4 text-emerald-600">@${u.username}</td>
                    <td class="p-4 text-[9px]">${u.rt} / ${u.jabatan}</td>
                    <td class="p-4 flex gap-2">
                        <button onclick="openEditUser('${u.username}', '${u.nama}', '${u.rt}', '${u.jabatan}', '${u.nomor_hp}')" class="text-blue-600"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deleteUser('${u.username}')" class="text-rose-600"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        async function deleteUser(user) {
            if(!confirm("Hapus warga?")) return;
            await fetch(`${SHEETDB_URL}/username/${user}?sheet=users`, { method: 'DELETE' });
            loadUsers();
        }

        function openEditUser(user, nama, rt, jab, hp) {
            document.getElementById('edit-old-user').value = user;
            document.getElementById('edit-nama').value = nama;
            document.getElementById('edit-rt').value = rt;
            document.getElementById('edit-jabatan').value = jab;
            document.getElementById('edit-hp').value = hp;
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal-edit').classList.add('hidden'); }

        async function updateUser() {
            const old = document.getElementById('edit-old-user').value;
            const data = { nama: document.getElementById('edit-nama').value, rt: document.getElementById('edit-rt').value, jabatan: document.getElementById('edit-jabatan').value, nomor_hp: document.getElementById('edit-hp').value };
            const res = await fetch(`${SHEETDB_URL}/username/${old}?sheet=users`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ data: data }) });
            if(res.ok) { alert("Selesai!"); closeModal(); loadUsers(); }
        }

        async function postDokumentasi() {
            const title = document.getElementById('d-judul').value;
            const file = document.getElementById('d-foto').files[0];
            if(!file || !title) return alert("Isi data!");
            const fileName = `doc_${Date.now()}.jpg`;
            await _supabase.storage.from('media-sinergi').upload(`kegiatan/${fileName}`, file);
            const { data: pUrl } = _supabase.storage.from('media-sinergi').getPublicUrl(`kegiatan/${fileName}`);
            await _supabase.from('dokumentasi').insert([{ judul: title, detail: title, foto_urls: [pUrl.publicUrl] }]);
            alert("Terbit!");
        }

        async function loadAbsensiData() {
            const res = await fetch(`${SHEETDB_URL}?sheet=absen`);
            const data = await res.json();
            document.getElementById('table-absen-body').innerHTML = data.reverse().map(d => `
                <tr class="border-t">
                    <td class="p-4 font-bold">${d.nama_warga}</td>
                    <td class="p-4">${d.rt}</td>
                    <td class="p-4 text-[9px] text-slate-400">${d.waktu_absen}</td>
                    <td class="p-4"><img src="${d.photo_selfie_url}" onclick="viewImage('${d.photo_selfie_url}', '${d.nama_warga}')" class="w-8 h-8 rounded border cursor-pointer"></td>
                </tr>
            `).join('');
        }

        async function postAgenda() {
            const data = { tanggal: document.getElementById('ag-tanggal').value, kegiatan: document.getElementById('ag-kegiatan').value, jam: document.getElementById('ag-jam').value, lokasi: document.getElementById('ag-lokasi').value };
            await fetch(`${SHEETDB_URL}?sheet=agenda`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ data: [data] }) });
            alert("Agenda Disimpan!"); loadAgendaAdmin();
        }

        async function loadAgendaAdmin() {
            const res = await fetch(`${SHEETDB_URL}?sheet=agenda`);
            const data = await res.json();
            document.getElementById('list-agenda-admin').innerHTML = data.reverse().map(a => `
                <div class="p-4 flex justify-between items-center">
                    <div><p class="text-[10px] font-black">${a.kegiatan}</p><p class="text-[8px] text-slate-400">${a.tanggal}</p></div>
                    <button onclick="hapusAgenda('${a.tanggal}')" class="text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function hapusAgenda(tgl) {
            await fetch(`${SHEETDB_URL}/tanggal/${tgl}?sheet=agenda`, { method: 'DELETE' });
            loadAgendaAdmin();
        }

        async function updateRunningText() {
            const text = document.getElementById('set-running-text').value;
            await fetch(`${SHEETDB_URL}/key/running_text?sheet=settings`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ data: { value: text } }) });
            alert("Teks Updated!");
        }

        function viewImage(url, cap) {
            document.getElementById('full-image').src = url;
            document.getElementById('image-caption').innerText = cap;
            document.getElementById('image-viewer').classList.remove('hidden');
        }

        function filterUser(val) {
            const rows = document.querySelectorAll('#table-user-body tr');
            rows.forEach(r => { r.style.display = r.cells[0].innerText.toLowerCase().includes(val.toLowerCase()) ? "" : "none"; });
        }

        function logoutAdmin() { if(confirm("Keluar?")) { localStorage.clear(); window.location.href = 'index.html'; } }

        window.onload = () => {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || user.jabatan !== 'Admin') { window.location.href = 'index.html'; }
            lucide.createIcons();
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        };
    </script>
</body>
</html>
